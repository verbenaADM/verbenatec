<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VerbenaTec - Ranking & Review</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        :root { --primary: #1E40AF; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            transition: background-color 0.3s, color 0.3s; 
            overflow-x: hidden;
            margin: 0;
            min-height: 100vh;
        }

        .dark { background-color: #030712; color: #ffffff !important; }
        html:not(.dark) { background-color: #ffffff; color: #000000 !important; }

        .dark p, .dark span, .dark h1, .dark h2, .dark h3, .dark h4, .dark div:not(.bg-primary):not(.no-contrast) { 
            color: #ffffff !important; 
        }
        html:not(.dark) p, html:not(.dark) span, html:not(.dark) h1, html:not(.dark) h2, html:not(.dark) h3, html:not(.dark) h4, html:not(.dark) div:not(.bg-primary):not(.no-contrast) { 
            color: #000000 !important; 
        }

        .text-primary { color: var(--primary) !important; }
        .text-blue-500 { color: #3b82f6 !important; }
        .text-gray-400 { color: #9ca3af !important; }
        .bg-primary * { color: #ffffff !important; }
        .text-white { color: #ffffff !important; }
        
        .line-clamp-1 { display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

        .modal-overlay { 
            background: rgba(0,0,0,0.9); 
            backdrop-filter: blur(12px); 
            position: fixed; 
            inset: 0; 
            z-index: 100; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 1rem; 
        }

        input, select, textarea { 
            width: 100%; 
            padding: 0.85rem; 
            border-radius: 0.75rem; 
            background: #f3f4f6; 
            outline: none; 
            border: 1px solid #d1d5db;
            color: #000000 !important;
            transition: border-color 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
        }

        .dark input, .dark select, .dark textarea { 
            background: #1f2937; 
            color: #ffffff !important; 
            border: 1px solid #374151; 
        }

        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }
        
        .card-shadow { box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1), 0 4px 10px -5px rgba(0, 0, 0, 0.05); }
        .dark .card-shadow { box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.5), 0 4px 10px -5px rgba(0, 0, 0, 0.3); }

        .btn-add {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-add:hover {
            transform: scale(1.05) translateY(-2px);
        }

        .form-section-title {
            position: relative;
            padding-left: 1rem;
        }
        .form-section-title::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 70%;
            background: var(--primary);
            border-radius: 2px;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { primary: '#1E40AF', accent: '#3B82F6' } 
                } 
            }
        }
    </script>
</head>
<body class="bg-white dark:bg-gray-950">

    <div id="root"></div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.3';
        import { GoogleGenAI } from 'https://esm.sh/@google/genai@1.34.0';

        const supabase = createClient('https://dybizeczoftefwxjptkm.supabase.co', 'sb_publishable_K6eACFcZ35n_bXocHNC-zQ_Tk1vW-9y');
        const genAI = new GoogleGenAI({ apiKey: process.env.API_KEY });

        window.state = {
            view: 'home',
            activeCategory: 'all',
            selectedId: null,
            products: [],
            news: [],
            user: JSON.parse(localStorage.getItem('verbenatec_user')) || null,
            isDarkMode: true,
            isMenuOpen: false,
            isAdminModalOpen: false,
            adminTab: 'product',
            isLoginModalOpen: false,
            editingItem: null,
            loading: true,
            selectedNewsProducts: [],
            isGeneratingAI: false
        };

        window.render = function() {
            const root = document.getElementById('root');
            if (!root) return;

            if (window.state.loading) {
                root.innerHTML = `
                    <div class="min-h-screen flex flex-col items-center justify-center bg-gray-950 text-white">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-blue-600 mb-4"></div>
                        <p class="font-black uppercase tracking-widest text-[10px] text-white">VerbenaTec Sincronizando...</p>
                    </div>`;
                return;
            }

            let viewContent = '';
            
            if (window.state.view === 'home') {
                const topTen = window.state.products.filter(p => p.is_top_ten).sort((a,b) => (a.rank || 99) - (b.rank || 99));
                viewContent = `
                    <div class="max-w-7xl mx-auto px-4 py-8 md:py-12 space-y-16 md:space-y-24 animate-fade-in">
                        <section>
                            <div class="flex items-center justify-between mb-8 md:mb-12">
                                <h2 class="text-2xl md:text-3xl font-black uppercase tracking-tighter border-l-8 border-primary pl-4">Radar News</h2>
                                ${window.state.user?.isAdmin ? `
                                    <button onclick="openAdminModal('news')" class="btn-add bg-primary !text-white px-4 py-2 rounded-xl font-black uppercase text-[10px] flex items-center shadow-lg">
                                        <i class="fas fa-plus mr-2"></i> Adicionar Not√≠cia
                                    </button>
                                ` : ''}
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12">
                                ${window.state.news.slice(0, 4).map(n => NewsCard(n)).join('')}
                            </div>
                        </section>
                        
                        <section class="bg-gray-100 dark:bg-gray-900/40 -mx-4 px-4 py-16 md:py-24 rounded-[3rem] md:rounded-[5rem]">
                            <div class="max-w-7xl mx-auto">
                                <div class="flex flex-col items-center mb-12 md:mb-20">
                                    <h2 class="text-2xl md:text-3xl font-black uppercase tracking-widest text-center mb-4">üèÜ Ranking Top 10</h2>
                                    ${window.state.user?.isAdmin ? `
                                        <button onclick="openAdminModal('product')" class="btn-add bg-blue-600 !text-white px-6 py-3 rounded-2xl font-black uppercase text-[10px] flex items-center shadow-xl">
                                            <i class="fas fa-plus mr-2"></i> Adicionar Novo Item
                                        </button>
                                    ` : ''}
                                </div>
                                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-8">
                                    ${topTen.slice(0,10).map(p => ProductCard(p)).join('')}
                                </div>
                            </div>
                        </section>
                    </div>`;
            } else if (window.state.view === 'category') {
                const filtered = window.state.products.filter(p => p.category === window.state.activeCategory || window.state.activeCategory === 'all');
                viewContent = `
                    <div class="max-w-7xl mx-auto px-4 py-12 animate-fade-in">
                        <div class="flex flex-col items-center mb-12">
                            <h1 class="text-4xl md:text-5xl font-black uppercase tracking-tighter text-primary mb-4 text-center !text-primary">${window.state.activeCategory}</h1>
                            ${window.state.user?.isAdmin ? `
                                <button onclick="openAdminModal('product')" class="btn-add bg-primary !text-white px-4 py-2 rounded-xl font-black uppercase text-[10px] shadow-lg">
                                    <i class="fas fa-plus mr-2"></i> Novo em ${window.state.activeCategory}
                                </button>
                            ` : ''}
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6 md:gap-8">
                            ${filtered.map(p => ProductCard(p)).join('')}
                        </div>
                    </div>`;
            } else if (window.state.view === 'product_detail') {
                const p = window.state.products.find(x => x.id === window.state.selectedId);
                if (!p) { window.navigate('home'); return; }
                viewContent = `
                    <div class="max-w-4xl mx-auto px-4 py-8 md:py-12 animate-fade-in">
                        <div class="flex justify-between items-center mb-8">
                            <button onclick="navigate('home')" class="font-black uppercase text-[10px] text-primary flex items-center group !text-primary">
                                <i class="fas fa-arrow-left mr-2 group-hover:-translate-x-1 transition-transform"></i> Voltar
                            </button>
                            ${window.state.user?.isAdmin ? `
                                <button onclick="openAdminModal('product', '${p.id}')" class="bg-blue-600 !text-white px-4 py-2 rounded-lg font-black uppercase text-[10px] shadow-lg">
                                    <i class="fas fa-edit mr-2"></i> Editar Item
                                </button>
                            ` : ''}
                        </div>
                        <div class="bg-white dark:bg-gray-900 rounded-[2.5rem] overflow-hidden card-shadow border dark:border-gray-800">
                            <div class="relative h-[300px] md:h-[500px]">
                                <img src="${p.image_url}" class="w-full h-full object-cover" alt="${p.name}" />
                                <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent flex items-end p-8 md:p-16">
                                    <h2 class="text-3xl md:text-6xl font-black text-white uppercase tracking-tighter leading-none !text-white">${p.name}</h2>
                                </div>
                            </div>
                            <div class="p-8 md:p-16">
                                <div class="flex flex-wrap items-center gap-10 md:gap-16 mb-12">
                                    <div class="text-center">
                                        <p class="text-[10px] font-black uppercase opacity-50 mb-1">Nota Review</p>
                                        <p class="text-5xl md:text-6xl font-black text-blue-500 !text-blue-500">${p.quality_score}</p>
                                    </div>
                                    <div class="h-16 w-px bg-gray-200 dark:bg-gray-800 hidden md:block"></div>
                                    <div>
                                        <p class="text-[10px] font-black uppercase opacity-50 mb-1">Melhor Pre√ßo</p>
                                        <div class="flex flex-col">
                                            <p class="text-3xl md:text-4xl font-black text-primary dark:text-blue-400 !text-primary dark:!text-blue-400">${formatCurrency(p.price_low)}</p>
                                            ${p.price_high > p.price_low ? `<span class="text-sm opacity-40 line-through font-bold">${formatCurrency(p.price_high)}</span>` : ''}
                                        </div>
                                    </div>
                                </div>
                                <div class="text-lg md:text-xl leading-relaxed whitespace-pre-line opacity-90 mb-12">${p.review || p.description}</div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t dark:border-gray-800 pt-10 mt-12">
                                    <a href="${p.affiliate_url}" target="_blank" class="bg-primary !text-white text-center py-6 rounded-2xl font-black uppercase shadow-xl hover:scale-[1.02] transition-transform">Comprar no Mercado Livre</a>
                                    ${p.amazon_url ? `<a href="${p.amazon_url}" target="_blank" class="bg-yellow-500 !text-black text-center py-6 rounded-2xl font-black uppercase shadow-xl hover:scale-[1.02] transition-transform">Comprar na Amazon</a>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>`;
            } else if (window.state.view === 'news_detail') {
                const n = window.state.news.find(x => x.id === window.state.selectedId);
                if (!n) { window.navigate('home'); return; }
                const related = window.state.products.filter(p => n.related_product_ids?.includes(p.id));
                viewContent = `
                    <div class="max-w-4xl mx-auto px-4 py-8 md:py-12 animate-fade-in">
                        <div class="flex justify-between items-center mb-8">
                            <button onclick="navigate('home')" class="font-black uppercase text-[10px] text-primary flex items-center group !text-primary">
                                <i class="fas fa-arrow-left mr-2 group-hover:-translate-x-1 transition-transform"></i> Voltar
                            </button>
                            ${window.state.user?.isAdmin ? `
                                <button onclick="openAdminModal('news', '${n.id}')" class="bg-blue-600 !text-white px-4 py-2 rounded-lg font-black uppercase text-[10px] shadow-lg">
                                    <i class="fas fa-edit mr-2"></i> Editar Not√≠cia
                                </button>
                            ` : ''}
                        </div>
                        <article class="bg-white dark:bg-gray-900 rounded-[2.5rem] overflow-hidden card-shadow border dark:border-gray-800">
                            <img src="${n.image_url}" class="w-full h-[300px] md:h-[500px] object-cover" alt="${n.title}" />
                            <div class="p-8 md:p-20">
                                <span class="inline-block px-4 py-1.5 bg-primary !text-white text-[10px] font-black uppercase rounded-full mb-8">${n.category}</span>
                                <h1 class="text-3xl md:text-6xl font-black uppercase tracking-tighter leading-none mb-12">${n.title}</h1>
                                <div class="text-lg md:text-xl leading-relaxed whitespace-pre-line mb-16 opacity-90">${n.content}</div>
                                ${related.length > 0 ? `
                                <div class="mt-20 pt-10 border-t dark:border-gray-800">
                                    <h3 class="text-xl font-black uppercase mb-10 flex items-center"><i class="fas fa-shopping-bag mr-3 text-primary !text-primary"></i> Itens Mencionados</h3>
                                    <div class="grid grid-cols-2 md:grid-cols-2 gap-6 md:gap-10">${related.map(p => ProductCard(p)).join('')}</div>
                                </div>` : ''}
                            </div>
                        </article>
                    </div>`;
            }

            root.innerHTML = `
                ${Header()}
                <main class="min-h-screen pt-4 pb-20">${viewContent}</main>
                ${Footer()}
                ${Modals()}
            `;
        };

        function Header() {
            const categories = ['all', 'celular', 'fones', 'videogames', 'jogos', 'acessorios'];
            return `
                <header class="sticky top-0 z-50 bg-white/90 dark:bg-gray-950/90 backdrop-blur-xl border-b dark:border-white/5 border-black/5">
                    <div class="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between">
                        <div onclick="navigate('home')" class="flex items-center space-x-2 cursor-pointer group">
                            <div class="bg-primary p-2.5 rounded-xl !text-white shadow-lg group-hover:scale-110 transition-transform">
                                <i class="fas fa-microchip text-xl"></i>
                            </div>
                            <h1 class="text-xl md:text-2xl font-black uppercase tracking-tighter">
                                verbenaTec<span class="text-[0.6em] text-blue-500 ml-1 !text-blue-500">.tr</span>
                            </h1>
                        </div>
                        <nav class="hidden lg:flex items-center space-x-8">
                            ${categories.map(c => `
                                <button onclick="navigate('category', null, '${c}')" class="text-[10px] font-black uppercase tracking-widest transition-all ${window.state.activeCategory === c ? 'text-primary scale-110 !text-primary' : 'opacity-50 hover:opacity-100'}">
                                    ${c === 'all' ? 'In√≠cio' : c}
                                </button>
                            `).join('')}
                            ${window.state.user?.isAdmin ? `
                                <div class="h-6 w-px bg-gray-200 dark:bg-gray-800 mx-2"></div>
                                <button onclick="openAdminModal('product')" class="bg-blue-600/10 text-blue-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase hover:bg-blue-600 hover:text-white transition-all">
                                    Painel Admin
                                </button>
                            ` : ''}
                        </nav>
                        <div class="flex items-center space-x-4">
                            <button onclick="toggleDarkMode()" class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                                <i class="fas ${window.state.isDarkMode ? 'fa-sun text-yellow-400 !text-yellow-400' : 'fa-moon text-blue-600 !text-blue-600'}"></i>
                            </button>
                            <button onclick="toggleMenu()" class="lg:hidden w-10 h-10 rounded-full flex items-center justify-center">
                                <i class="fas ${window.state.isMenuOpen ? 'fa-times' : 'fa-bars'}"></i>
                            </button>
                            <button onclick="window.state.isLoginModalOpen = true; render();" class="bg-primary !text-white w-10 h-10 rounded-full flex items-center justify-center hover:brightness-110 transition shadow-md">
                                <i class="fas fa-user-shield"></i>
                            </button>
                        </div>
                    </div>
                </header>
                ${window.state.isMenuOpen ? `
                <div class="lg:hidden fixed inset-0 z-[100] bg-black/60" onclick="toggleMenu()">
                    <div class="bg-white dark:bg-gray-900 w-80 h-full ml-auto p-10 flex flex-col shadow-2xl animate-fade-in" onclick="event.stopPropagation()">
                         <div class="flex justify-between items-center mb-12">
                             <span class="font-black uppercase text-xs tracking-widest opacity-40">Navega√ß√£o</span>
                             <button onclick="toggleMenu()"><i class="fas fa-times text-xl"></i></button>
                         </div>
                         <div class="space-y-8 flex-1">
                            ${categories.map(c => `
                                <button onclick="navigate('category', null, '${c}')" class="block w-full text-left font-black uppercase text-lg ${window.state.activeCategory === c ? 'text-primary !text-primary' : ''}">
                                    ${c}
                                </button>
                            `).join('')}
                         </div>
                         <div class="pt-8 border-t dark:border-gray-800 space-y-4">
                             ${window.state.user?.isAdmin ? `
                                <button onclick="openAdminModal('product'); window.state.isMenuOpen=false; render();" class="w-full bg-blue-600 !text-white py-4 rounded-2xl font-black uppercase text-xs shadow-xl">Painel Admin</button>
                             ` : ''}
                             ${window.state.user ? `
                                <button onclick="logout()" class="w-full text-red-500 font-black uppercase text-[10px] text-center !text-red-500">Sair da Conta</button>
                             ` : ''}
                         </div>
                    </div>
                </div>` : ''}
            `;
        }

        function ProductCard(p) {
            return `
                <div class="bg-white dark:bg-gray-800 rounded-[2rem] overflow-hidden card-shadow border dark:border-gray-700 flex flex-col h-full group relative transition-all duration-300 hover:scale-[1.03]">
                    ${window.state.user?.isAdmin ? `
                        <div class="absolute top-3 right-3 z-20 flex gap-2">
                            <button onclick="openAdminModal('product', '${p.id}')" class="bg-blue-600 !text-white w-8 h-8 rounded-lg flex items-center justify-center text-[10px] shadow-lg"><i class="fas fa-edit"></i></button>
                            <button onclick="handleDelete('products', '${p.id}')" class="bg-red-600 !text-white w-8 h-8 rounded-lg flex items-center justify-center text-[10px] shadow-lg"><i class="fas fa-trash"></i></button>
                        </div>` : ''}
                    <div class="h-44 md:h-52 overflow-hidden cursor-pointer" onclick="navigate('product_detail', '${p.id}')">
                        <img src="${p.image_url}" alt="${p.name}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110" />
                        ${p.is_top_ten ? `<div class="absolute top-4 left-4 bg-primary !text-white text-[10px] font-black px-2.5 py-1 rounded-lg shadow-lg">#${p.rank || 'TOP'}</div>` : ''}
                    </div>
                    <div class="p-5 md:p-6 flex flex-col flex-grow">
                        <h3 class="font-black text-sm uppercase mb-4 line-clamp-1 leading-tight">${p.name}</h3>
                        <div class="mt-auto">
                            <div class="flex flex-col mb-5">
                                <span class="text-lg font-black text-primary dark:text-blue-400 leading-none !text-primary dark:!text-blue-400">${formatCurrency(p.price_low)}</span>
                                ${p.price_high > p.price_low ? `<span class="text-[10px] opacity-40 line-through font-bold mt-1">${formatCurrency(p.price_high)}</span>` : ''}
                            </div>
                            <div class="grid grid-cols-1 gap-2">
                                <button onclick="navigate('product_detail', '${p.id}')" class="w-full bg-primary/10 text-primary dark:text-blue-400 py-3 rounded-xl text-[10px] font-black uppercase hover:bg-primary hover:!text-white transition-all !text-primary dark:!text-blue-400">Review Completo</button>
                                <a href="${p.affiliate_url}" target="_blank" class="block w-full bg-primary !text-white text-center py-3 rounded-xl text-[10px] font-black uppercase shadow-md hover:brightness-110 transition-all">Mercado Livre</a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function NewsCard(n) {
            return `
                <div class="bg-white dark:bg-gray-900 rounded-[2.5rem] overflow-hidden card-shadow group relative cursor-pointer border dark:border-gray-800 transition-all duration-300 hover:border-primary/50" onclick="navigate('news_detail', '${n.id}')">
                    ${window.state.user?.isAdmin ? `
                        <div class="absolute top-6 right-6 z-20 flex gap-3">
                            <button onclick="event.stopPropagation(); openAdminModal('news', '${n.id}')" class="bg-blue-600 !text-white w-10 h-10 rounded-xl flex items-center justify-center text-xs shadow-xl"><i class="fas fa-edit"></i></button>
                            <button onclick="event.stopPropagation(); handleDelete('news', '${n.id}')" class="bg-red-600 !text-white w-10 h-10 rounded-xl flex items-center justify-center text-xs shadow-xl"><i class="fas fa-trash"></i></button>
                        </div>` : ''}
                    <div class="h-72 overflow-hidden">
                        <img src="${n.image_url}" alt="${n.title}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-1000" />
                    </div>
                    <div class="p-8 md:p-12">
                        <span class="text-[10px] font-black uppercase text-primary tracking-widest mb-4 block !text-primary">${n.category} ‚Ä¢ ${n.date}</span>
                        <h3 class="text-2xl md:text-3xl font-black uppercase group-hover:text-primary transition-colors line-clamp-2 leading-[1.1]">${n.title}</h3>
                        <p class="opacity-60 text-sm mt-6 line-clamp-2 leading-relaxed">${n.content}</p>
                    </div>
                </div>
            `;
        }

        function Footer() {
            return `
                <footer class="bg-primary !text-white py-24 mt-24">
                    <div class="max-w-7xl mx-auto px-4 text-center">
                        <div class="flex justify-center items-center space-x-3 mb-8 group cursor-pointer" onclick="navigate('home')">
                            <div class="bg-white p-3 rounded-2xl text-primary shadow-xl group-hover:rotate-12 transition-transform !text-primary">
                                <i class="fas fa-microchip text-3xl"></i>
                            </div>
                            <span class="font-black text-4xl uppercase tracking-tighter !text-white">verbenaTec</span>
                        </div>
                        <p class="text-[10px] text-blue-200 uppercase font-black tracking-widest opacity-60 mb-12 !text-blue-200">Seu Portal de Tecnologia & Lifestyle Gamer ‚Ä¢ 2024</p>
                    </div>
                </footer>`;
        }

        function Modals() {
            return `
                ${window.state.isLoginModalOpen ? `
                <div class="modal-overlay" onclick="window.state.isLoginModalOpen = false; render();">
                    <div class="bg-white dark:bg-gray-900 w-full max-w-md rounded-[2.5rem] p-10 shadow-2xl animate-fade-in border dark:border-gray-800" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-10">
                            <h2 class="text-3xl font-black uppercase tracking-tighter">Admin Login</h2>
                            <button onclick="window.state.isLoginModalOpen = false; render();" class="text-gray-400 hover:text-red-500 transition"><i class="fas fa-times text-xl"></i></button>
                        </div>
                        <form onsubmit="handleAuth(event)" class="space-y-6">
                            <input type="email" name="email" placeholder="admin@verbenatec.com" required />
                            <input type="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
                            <button type="submit" class="w-full bg-primary !text-white py-5 rounded-2xl font-black uppercase tracking-widest shadow-2xl hover:brightness-110 transition-all mt-6">Entrar no Painel</button>
                        </form>
                    </div>
                </div>` : ''}

                ${window.state.isAdminModalOpen ? `
                <div class="modal-overlay overflow-y-auto" onclick="window.state.isAdminModalOpen = false; render();">
                    <div class="bg-white dark:bg-gray-950 w-full max-w-4xl rounded-[3rem] p-8 md:p-14 my-10 shadow-2xl animate-fade-in border dark:border-gray-800" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-10">
                            <h2 class="text-3xl font-black uppercase tracking-tighter">
                                ${window.state.editingItem ? 'Editar Registro' : 'Novo Conte√∫do'}
                            </h2>
                            <button onclick="window.state.isAdminModalOpen = false; render();" class="bg-gray-100 dark:bg-gray-800 w-12 h-12 rounded-full flex items-center justify-center hover:bg-red-500 hover:!text-white transition-all"><i class="fas fa-times"></i></button>
                        </div>
                        
                        <div class="flex space-x-2 mb-10 p-1.5 bg-gray-100 dark:bg-gray-900 rounded-2xl border dark:border-gray-800">
                            <button onclick="window.state.adminTab = 'product'; render();" class="flex-1 py-4 rounded-xl font-black uppercase text-[10px] transition-all ${window.state.adminTab === 'product' ? 'bg-primary !text-white shadow-xl' : 'opacity-40'}">Produtos & Reviews</button>
                            <button onclick="window.state.adminTab = 'news'; render();" class="flex-1 py-4 rounded-xl font-black uppercase text-[10px] transition-all ${window.state.adminTab === 'news' ? 'bg-primary !text-white shadow-xl' : 'opacity-40'}">Not√≠cias Verbena</button>
                        </div>

                        ${window.state.adminTab === 'product' ? `
                        <form onsubmit="handleSaveProduct(event)" class="space-y-10">
                            <div class="space-y-6">
                                <h3 class="form-section-title font-black uppercase text-xs opacity-50 tracking-widest">Informa√ß√µes B√°sicas</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="col-span-full space-y-1">
                                        <label class="text-[10px] font-black uppercase opacity-40 ml-1">Nome do Produto</label>
                                        <input name="name" value="${window.state.editingItem?.name || ''}" placeholder="Ex: iPhone 15 Pro Max" required />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-[10px] font-black uppercase opacity-40 ml-1">Categoria</label>
                                        <select name="category" required>
                                            ${['celular', 'fones', 'videogames', 'jogos', 'acessorios'].map(c => `<option value="${c}" ${window.state.editingItem?.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-[10px] font-black uppercase opacity-40 ml-1">URL da Imagem</label>
                                        <input name="image_url" value="${window.state.editingItem?.image_url || ''}" placeholder="https://..." required />
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-6">
                                <h3 class="form-section-title font-black uppercase text-xs opacity-50 tracking-widest">Valores e Ranking</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div class="space-y-1">
                                        <label class="text-[10px] font-black uppercase opacity-40 ml-1">Pre√ßo Atual</label>
                                        <input name="price_low_masked" oninput="maskCurrency(this)" value="${formatPriceValue(window.state.editingItem?.price_low)}" placeholder="R$ 0,00" required />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-[10px] font-black uppercase opacity-40 ml-1">Pre√ßo Original (Riscado)</label>
                                        <input name="price_high_masked" oninput="maskCurrency(this)" value="${formatPriceValue(window.state.editingItem?.price_high)}" placeholder="R$ 0,00" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-[10px] font-black uppercase opacity-40 ml-1">Nota Geral (0-10)</label>
                                        <input name="quality_score" type="number" step="0.1" value="${window.state.editingItem?.quality_score || ''}" required />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-[10px] font-black uppercase opacity-40 ml-1">Posi√ß√£o Ranking</label>
                                        <input name="rank" type="number" value="${window.state.editingItem?.rank || ''}" />
                                    </div>
                                    <div class="col-span-2 p-4 bg-gray-50 dark:bg-gray-900 rounded-[1rem] border dark:border-gray-800 flex items-center">
                                        <label class="flex items-center space-x-3 cursor-pointer">
                                            <input name="is_top_ten" type="checkbox" ${window.state.editingItem?.is_top_ten ? 'checked' : ''} class="w-6 h-6 rounded-lg accent-primary" />
                                            <span class="font-black uppercase text-[10px]">Ativar no Top 10 Oficial</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-6">
                                <h3 class="form-section-title font-black uppercase text-xs opacity-50 tracking-widest">Links de Afiliados</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="space-y-1">
                                        <label class="text-[10px] font-black uppercase opacity-40 ml-1">Link Mercado Livre</label>
                                        <input name="affiliate_url" value="${window.state.editingItem?.affiliate_url || ''}" placeholder="https://mercadolivre.com/..." required />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-[10px] font-black uppercase opacity-40 ml-1">Link Amazon</label>
                                        <input name="amazon_url" value="${window.state.editingItem?.amazon_url || ''}" placeholder="https://amazon.com.br/..." />
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-6">
                                <div class="flex justify-between items-center">
                                    <h3 class="form-section-title font-black uppercase text-xs opacity-50 tracking-widest">Conte√∫do do Review</h3>
                                    <button type="button" onclick="generateAIReview()" class="text-[10px] font-black text-blue-500 uppercase hover:underline flex items-center !text-blue-500 no-contrast">
                                        ${window.state.isGeneratingAI ? '<i class="fas fa-spinner fa-spin mr-1"></i> Criando...' : '<i class="fas fa-robot mr-1"></i> Gerar com Gemini'}
                                    </button>
                                </div>
                                <textarea name="review" id="review_field" class="h-44" placeholder="Escreva os detalhes ou gere com IA...">${window.state.editingItem?.review || ''}</textarea>
                            </div>

                            <button type="submit" class="w-full bg-primary !text-white py-6 rounded-2xl font-black uppercase shadow-2xl hover:brightness-110 transition-all">Salvar Item no Banco</button>
                        </form>` : `
                        <form onsubmit="handleSaveNews(event)" class="space-y-10">
                            <div class="space-y-6">
                                <h3 class="form-section-title font-black uppercase text-xs opacity-50 tracking-widest">Manchete e M√≠dia</h3>
                                <div class="space-y-4">
                                    <div class="space-y-1">
                                        <label class="text-[10px] font-black uppercase opacity-40 ml-1">T√≠tulo da Mat√©ria</label>
                                        <input name="title" value="${window.state.editingItem?.title || ''}" placeholder="Manchete principal..." required />
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div class="space-y-1">
                                            <label class="text-[10px] font-black uppercase opacity-40 ml-1">Assunto Principal</label>
                                            <select name="category" required>
                                                ${['celular', 'fones', 'videogames', 'jogos', 'acessorios'].map(c => `<option value="${c}" ${window.state.editingItem?.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div class="space-y-1">
                                            <label class="text-[10px] font-black uppercase opacity-40 ml-1">URL Imagem de Capa</label>
                                            <input name="image_url" value="${window.state.editingItem?.image_url || ''}" required />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-6">
                                <h3 class="form-section-title font-black uppercase text-xs opacity-50 tracking-widest">Itens Relacionados</h3>
                                <div class="p-6 bg-gray-50 dark:bg-gray-900 rounded-[2rem] border dark:border-gray-800">
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 max-h-52 overflow-y-auto pr-2">
                                        ${window.state.products.map(p => `
                                            <label class="flex items-center space-x-3 text-[10px] font-bold p-3 bg-white dark:bg-gray-800 rounded-xl cursor-pointer border dark:border-gray-700 hover:border-primary transition-all">
                                                <input type="checkbox" onchange="toggleRelatedProduct('${p.id}')" ${window.state.selectedNewsProducts.includes(p.id) ? 'checked' : ''} class="w-4 h-4 rounded accent-primary" />
                                                <span class="truncate">${p.name}</span>
                                            </label>`).join('')}
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-6">
                                <h3 class="form-section-title font-black uppercase text-xs opacity-50 tracking-widest">Texto Completo</h3>
                                <textarea name="content" class="h-80" placeholder="Escreva o texto completo da not√≠cia aqui..." required>${window.state.editingItem?.content || ''}</textarea>
                            </div>

                            <button type="submit" class="w-full bg-primary !text-white py-6 rounded-2xl font-black uppercase shadow-2xl hover:brightness-110 transition-all">Publicar Artigo</button>
                        </form>`}
                    </div>
                </div>` : ''}
            `;
        }

        // --- UTILS ---
        window.maskCurrency = (input) => {
            let value = input.value.replace(/\D/g, "");
            value = (value / 100).toFixed(2) + "";
            value = value.replace(".", ",");
            value = value.replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,");
            value = value.replace(/(\d)(\d{3}),/g, "$1.$2,");
            input.value = value !== "NaN" ? "R$ " + value : "";
        };

        const formatPriceValue = (val) => {
            if (!val) return "";
            let formatted = Number(val).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            return "R$ " + formatted;
        };

        const unmaskPrice = (val) => {
            if (!val) return 0;
            return parseFloat(val.replace("R$ ", "").replace(/\./g, "").replace(",", "."));
        };

        async function fetchData() {
            window.state.loading = true;
            window.render();
            try {
                const [pRes, nRes] = await Promise.all([
                    supabase.from('products').select('*').order('created_at', { ascending: false }),
                    supabase.from('news').select('*').order('created_at', { ascending: false })
                ]);
                window.state.products = pRes.data || [];
                window.state.news = nRes.data || [];
            } catch (err) {
                console.error("Erro na base de dados:", err);
            } finally {
                window.state.loading = false;
                window.render();
            }
        }

        window.navigate = (view, id = null, category = 'all') => {
            window.state.view = view;
            window.state.selectedId = id;
            window.state.activeCategory = category;
            window.state.isMenuOpen = false;
            window.scrollTo({ top: 0, behavior: 'smooth' });
            window.render();
        };

        window.toggleDarkMode = () => {
            window.state.isDarkMode = !window.state.isDarkMode;
            document.documentElement.classList.toggle('dark', window.state.isDarkMode);
            window.render();
        };

        window.toggleMenu = () => {
            window.state.isMenuOpen = !window.state.isMenuOpen;
            window.render();
        };

        window.handleAuth = (event) => {
            event.preventDefault();
            const email = event.target.email.value;
            const pass = event.target.password.value;
            if (email === 'emanuelrothmamn@gmail.com' && pass === 'senhadmin') {
                window.state.user = { email, isAdmin: true, name: 'Verbena Admin' };
                localStorage.setItem('verbenatec_user', JSON.stringify(window.state.user));
                window.state.isLoginModalOpen = false;
                window.render();
            } else {
                alert("Acesso negado. Credenciais inv√°lidas.");
            }
        };

        window.logout = () => {
            window.state.user = null;
            localStorage.removeItem('verbenatec_user');
            window.state.isMenuOpen = false;
            window.render();
        };

        window.handleDelete = async (table, id) => {
            if (!confirm(`Confirmar exclus√£o definitiva?`)) return;
            const { error } = await supabase.from(table).delete().eq('id', id);
            if (!error) fetchData();
            else alert("Erro ao deletar: " + error.message);
        };

        window.openAdminModal = (tab, id = null) => {
            window.state.adminTab = tab;
            if (id) {
                const list = tab === 'product' ? window.state.products : window.state.news;
                const item = list.find(i => i.id === id);
                window.state.editingItem = JSON.parse(JSON.stringify(item));
                window.state.selectedNewsProducts = item.related_product_ids || [];
            } else {
                window.state.editingItem = null;
                window.state.selectedNewsProducts = [];
            }
            window.state.isAdminModalOpen = true;
            window.render();
        };

        window.handleSaveProduct = async (event) => {
            event.preventDefault();
            const fd = new FormData(event.target);
            const id = window.state.editingItem?.id || Math.random().toString(36).substr(2, 9);
            
            const payload = {
                id,
                name: fd.get('name'),
                category: fd.get('category'),
                description: fd.get('review').substring(0, 150),
                quality_score: Number(fd.get('quality_score')),
                price_low: unmaskPrice(fd.get('price_low_masked')),
                price_high: unmaskPrice(fd.get('price_high_masked')),
                is_top_ten: fd.get('is_top_ten') === 'on',
                rank: fd.get('rank') ? Number(fd.get('rank')) : null,
                image_url: fd.get('image_url'),
                affiliate_url: fd.get('affiliate_url'),
                amazon_url: fd.get('amazon_url'),
                review: fd.get('review')
            };

            const { error } = await (window.state.editingItem 
                ? supabase.from('products').update(payload).eq('id', id)
                : supabase.from('products').insert([payload]));

            if (!error) {
                window.state.isAdminModalOpen = false;
                fetchData();
            } else alert(error.message);
        };

        window.handleSaveNews = async (event) => {
            event.preventDefault();
            const fd = new FormData(event.target);
            const id = window.state.editingItem?.id || Math.random().toString(36).substr(2, 9);
            
            const payload = {
                id,
                title: fd.get('title'),
                content: fd.get('content'),
                category: fd.get('category'),
                image_url: fd.get('image_url'),
                date: window.state.editingItem?.date || new Date().toLocaleDateString('pt-BR'),
                related_product_ids: window.state.selectedNewsProducts
            };

            const { error } = await (window.state.editingItem 
                ? supabase.from('news').update(payload).eq('id', id)
                : supabase.from('news').insert([payload]));

            if (!error) {
                window.state.isAdminModalOpen = false;
                fetchData();
            } else alert(error.message);
        };

        window.toggleRelatedProduct = (id) => {
            if (window.state.selectedNewsProducts.includes(id)) {
                window.state.selectedNewsProducts = window.state.selectedNewsProducts.filter(i => i !== id);
            } else {
                window.state.selectedNewsProducts.push(id);
            }
        };

        window.generateAIReview = async () => {
            const name = document.querySelector('input[name="name"]').value;
            const cat = document.querySelector('select[name="category"]').value;
            if (!name) return alert("Insira o nome do produto primeiro.");

            window.state.isGeneratingAI = true;
            window.render();

            try {
                const response = await genAI.models.generateContent({
                    model: 'gemini-3-flash-preview',
                    contents: `Atue como um especialista em tecnologia. Escreva um review t√©cnico curto (m√°ximo 150 palavras) e atraente para o produto: ${name} da categoria ${cat}. Destaque pontos positivos, negativos e d√™ um veredito final em portugu√™s do Brasil.`,
                });
                const field = document.getElementById('review_field');
                if (field) field.value = response.text;
            } catch (e) {
                console.error(e);
                alert("Erro ao conectar com Gemini AI.");
            } finally {
                window.state.isGeneratingAI = false;
                window.render();
            }
        };

        const formatCurrency = (val) => Number(val).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        fetchData();
    </script>
</body>
</html>