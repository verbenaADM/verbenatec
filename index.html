<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VerbenaTec - Ranking & Review</title>
    <meta name="description" content="Blog especializado em reviews de celulares, fones, games e acess√≥rios com listas Top 10 e links de afiliados.">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        :root { --primary: #1E40AF; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            transition: background-color 0.3s, color 0.3s; 
            overflow-x: hidden;
            margin: 0;
            min-height: 100vh;
        }

        .dark { background-color: #030712; color: #ffffff; }
        html:not(.dark) { background-color: #ffffff; color: #000000; }

        /* Estilos de Contraste e Cores */
        .dark p, .dark span, .dark h1, .dark h2, .dark h3, .dark h4, .dark label, .dark div:not(.bg-primary):not(.no-contrast) { 
            color: #ffffff !important; 
        }
        html:not(.dark) p, html:not(.dark) span, html:not(.dark) h1, html:not(.dark) h2, html:not(.dark) h3, html:not(.dark) h4, html:not(.dark) label, html:not(.dark) div:not(.bg-primary):not(.no-contrast) { 
            color: #000000 !important; 
        }

        .text-primary { color: var(--primary) !important; }
        .bg-primary { background-color: var(--primary) !important; }
        .text-white { color: #ffffff !important; }
        
        /* Utilit√°rios de Texto */
        .line-clamp-1 { display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* Modais */
        .modal-overlay { 
            background: rgba(0,0,0,0.95); 
            backdrop-filter: blur(16px); 
            position: fixed; 
            inset: 0; 
            z-index: 100; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 1rem; 
        }

        /* Inputs Organizados */
        input, select, textarea { 
            width: 100%; 
            padding: 1rem; 
            border-radius: 1rem; 
            background: #f3f4f6; 
            outline: none; 
            border: 2px solid transparent;
            color: #000000 !important;
            transition: all 0.2s;
        }
        .dark input, .dark select, .dark textarea { 
            background: #111827; 
            color: #ffffff !important; 
            border: 2px solid #1f2937; 
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(30, 64, 175, 0.1);
        }

        /* Anima√ß√µes */
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Shadow e Layout */
        .card-shadow { box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.2); }
        .dark .card-shadow { box-shadow: 0 20px 50px -15px rgba(0, 0, 0, 0.6); }

        .price-item {
            border-left: 4px solid var(--primary);
            padding: 0.75rem 1rem;
            background: rgba(30, 64, 175, 0.05);
            border-radius: 0 1rem 1rem 0;
        }

        .form-header {
            border-bottom: 1px solid rgba(128, 128, 128, 0.1);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { primary: '#1E40AF' } 
                } 
            }
        }
    </script>
</head>
<body class="bg-white dark:bg-gray-950">

    <div id="root"></div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.3';
        import { GoogleGenAI } from 'https://esm.sh/@google/genai@1.34.0';

        // Configura√ß√µes Globais
        const supabase = createClient('https://dybizeczoftefwxjptkm.supabase.co', 'sb_publishable_K6eACFcZ35n_bXocHNC-zQ_Tk1vW-9y');
        const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

        // Estado Global da Aplica√ß√£o
        window.state = {
            view: 'home',
            activeCategory: 'all',
            selectedId: null,
            products: [],
            news: [],
            user: JSON.parse(localStorage.getItem('verbenatec_user')) || null,
            isDarkMode: true,
            isMenuOpen: false,
            isAdminModalOpen: false,
            adminTab: 'product',
            isLoginModalOpen: false,
            editingItem: null,
            loading: true,
            selectedNewsProducts: [],
            isGeneratingAI: false
        };

        // Fun√ß√£o de Renderiza√ß√£o Principal (Vanilla render loop)
        window.render = function() {
            const root = document.getElementById('root');
            if (!root) return;

            if (window.state.loading) {
                root.innerHTML = `
                    <div class="min-h-screen flex flex-col items-center justify-center bg-gray-950 text-white">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-blue-600 mb-4"></div>
                        <p class="font-black uppercase tracking-widest text-[10px]">VerbenaTec Sincronizando...</p>
                    </div>`;
                return;
            }

            let viewContent = '';
            
            // L√≥gica de Roteamento de Views
            if (window.state.view === 'home') {
                const topTen = window.state.products.filter(p => p.is_top_ten).sort((a,b) => (a.rank || 99) - (b.rank || 99));
                viewContent = `
                    <div class="max-w-7xl mx-auto px-4 py-8 md:py-12 space-y-16 animate-fade-in">
                        <section>
                            <div class="flex items-center justify-between mb-8">
                                <h2 class="text-2xl md:text-3xl font-black uppercase tracking-tighter border-l-8 border-primary pl-4">Radar News</h2>
                                ${window.state.user?.isAdmin ? `
                                    <button onclick="openAdminModal('news')" class="bg-primary !text-white px-5 py-2.5 rounded-2xl font-black uppercase text-[10px] shadow-xl hover:scale-105 transition">
                                        <i class="fas fa-plus mr-2"></i> Adicionar Not√≠cia
                                    </button>
                                ` : ''}
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                ${window.state.news.slice(0, 4).map(n => NewsCard(n)).join('')}
                            </div>
                        </section>
                        
                        <section class="bg-gray-100 dark:bg-gray-900/40 -mx-4 px-4 py-16 rounded-[3rem]">
                            <div class="max-w-7xl mx-auto">
                                <div class="flex flex-col items-center mb-12">
                                    <h2 class="text-2xl md:text-3xl font-black uppercase tracking-widest text-center mb-6">üèÜ Ranking Top 10</h2>
                                    ${window.state.user?.isAdmin ? `
                                        <button onclick="openAdminModal('product')" class="bg-blue-600 !text-white px-8 py-4 rounded-2xl font-black uppercase text-[10px] shadow-2xl hover:scale-105 transition">
                                            <i class="fas fa-plus mr-2"></i> Adicionar Novo Item
                                        </button>
                                    ` : ''}
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6">
                                    ${topTen.slice(0,10).map(p => ProductCard(p)).join('')}
                                </div>
                            </div>
                        </section>
                    </div>`;
            } else if (window.state.view === 'category') {
                const filtered = window.state.products.filter(p => p.category === window.state.activeCategory || window.state.activeCategory === 'all');
                viewContent = `
                    <div class="max-w-7xl mx-auto px-4 py-12 animate-fade-in">
                        <div class="flex flex-col items-center mb-16">
                            <h1 class="text-4xl md:text-5xl font-black uppercase tracking-tighter text-primary mb-6 !text-primary">${window.state.activeCategory}</h1>
                            ${window.state.user?.isAdmin ? `
                                <button onclick="openAdminModal('product')" class="bg-primary !text-white px-6 py-3 rounded-2xl font-black uppercase text-[10px] shadow-2xl hover:scale-105 transition">
                                    <i class="fas fa-plus mr-2"></i> Novo em ${window.state.activeCategory}
                                </button>
                            ` : ''}
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6">
                            ${filtered.map(p => ProductCard(p)).join('')}
                        </div>
                    </div>`;
            } else if (window.state.view === 'product_detail') {
                const p = window.state.products.find(x => x.id === window.state.selectedId);
                if (!p) { window.navigate('home'); return; }
                viewContent = `
                    <div class="max-w-4xl mx-auto px-4 py-12 animate-fade-in">
                        <button onclick="navigate('home')" class="font-black uppercase text-[10px] text-primary mb-8 flex items-center group !text-primary">
                            <i class="fas fa-arrow-left mr-2 group-hover:-translate-x-1 transition"></i> Voltar
                        </button>
                        <div class="bg-white dark:bg-gray-900 rounded-[3rem] overflow-hidden card-shadow border dark:border-gray-800">
                            <img src="${p.image_url}" class="w-full h-[300px] md:h-[500px] object-cover" />
                            <div class="p-8 md:p-16">
                                <h1 class="text-4xl md:text-6xl font-black uppercase tracking-tighter mb-12">${p.name}</h1>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-16">
                                    <div class="text-center p-6 bg-gray-50 dark:bg-gray-800 rounded-3xl">
                                        <p class="text-[10px] font-black uppercase opacity-50 mb-1">Nota Review</p>
                                        <p class="text-5xl font-black text-blue-500 !text-blue-500">${p.quality_score}</p>
                                    </div>
                                    <div class="md:col-span-2 flex flex-col space-y-4">
                                        <div class="price-item">
                                            <p class="text-[9px] font-black uppercase opacity-40">Pre√ßo Mercado Livre</p>
                                            <p class="text-3xl font-black text-primary !text-primary">${formatCurrency(p.price_ml || p.price_low)}</p>
                                        </div>
                                        <div class="price-item" style="border-left-color: #EAB308;">
                                            <p class="text-[9px] font-black uppercase opacity-40">Pre√ßo Amazon</p>
                                            <p class="text-3xl font-black text-yellow-600 !text-yellow-600">${p.price_amazon ? formatCurrency(p.price_amazon) : 'Consulte'}</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="text-lg leading-relaxed whitespace-pre-line mb-16 opacity-90">${p.review || p.description}</div>
                                
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 border-t dark:border-gray-800 pt-12">
                                    <a href="${p.affiliate_url}" target="_blank" class="bg-primary !text-white text-center py-6 rounded-2xl font-black uppercase shadow-2xl hover:scale-105 transition">Comprar no Mercado Livre</a>
                                    ${p.amazon_url ? `<a href="${p.amazon_url}" target="_blank" class="bg-yellow-500 !text-black text-center py-6 rounded-2xl font-black uppercase shadow-2xl hover:scale-105 transition">Comprar na Amazon</a>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>`;
            } else if (window.state.view === 'news_detail') {
                const n = window.state.news.find(x => x.id === window.state.selectedId);
                if (!n) { window.navigate('home'); return; }
                const related = window.state.products.filter(p => n.related_product_ids?.includes(p.id));
                viewContent = `
                    <div class="max-w-4xl mx-auto px-4 py-12 animate-fade-in">
                        <button onclick="navigate('home')" class="font-black uppercase text-[10px] text-primary mb-8 flex items-center group !text-primary">
                            <i class="fas fa-arrow-left mr-2 group-hover:-translate-x-1 transition"></i> Voltar
                        </button>
                        <article class="bg-white dark:bg-gray-900 rounded-[3rem] overflow-hidden card-shadow border dark:border-gray-800">
                            <img src="${n.image_url}" class="w-full h-[400px] object-cover" />
                            <div class="p-8 md:p-20">
                                <span class="text-[10px] font-black uppercase bg-primary !text-white px-4 py-1.5 rounded-full mb-8 inline-block">${n.category}</span>
                                <h1 class="text-3xl md:text-5xl font-black uppercase mb-12 tracking-tighter">${n.title}</h1>
                                <div class="text-lg leading-relaxed whitespace-pre-line mb-16 opacity-90">${n.content}</div>
                                ${related.length > 0 ? `
                                    <div class="border-t dark:border-gray-800 pt-12 mt-12">
                                        <h3 class="text-xl font-black uppercase mb-8"><i class="fas fa-tag mr-2 text-primary !text-primary"></i> Itens Mencionados</h3>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">${related.map(p => ProductCard(p)).join('')}</div>
                                    </div>
                                ` : ''}
                            </div>
                        </article>
                    </div>`;
            }

            root.innerHTML = `
                ${Header()}
                <main class="min-h-screen pb-20">${viewContent}</main>
                ${Footer()}
                ${Modals()}
            `;
        };

        // --- COMPONENTES DE UI ---

        function Header() {
            const categories = ['all', 'celular', 'fones', 'videogames', 'jogos', 'acessorios'];
            return `
                <header class="sticky top-0 z-50 bg-white/80 dark:bg-gray-950/80 backdrop-blur-xl border-b dark:border-white/5 h-24">
                    <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
                        <div onclick="navigate('home')" class="flex items-center space-x-3 cursor-pointer group">
                            <div class="bg-primary p-2.5 rounded-xl !text-white shadow-xl group-hover:rotate-12 transition">
                                <i class="fas fa-bolt text-2xl"></i>
                            </div>
                            <h1 class="text-2xl font-black uppercase tracking-tighter">verbenaTec<span class="text-blue-500 !text-blue-500">.</span></h1>
                        </div>
                        <nav class="hidden lg:flex items-center space-x-8">
                            ${categories.map(c => `
                                <button onclick="navigate('category', null, '${c}')" class="text-[10px] font-black uppercase tracking-widest transition ${window.state.activeCategory === c ? 'text-primary scale-110 !text-primary' : 'opacity-40 hover:opacity-100'}">
                                    ${c === 'all' ? 'Radar' : c}
                                </button>
                            `).join('')}
                        </nav>
                        <div class="flex items-center space-x-4">
                            <button onclick="toggleDarkMode()" class="w-10 h-10 rounded-xl flex items-center justify-center bg-gray-100 dark:bg-gray-900">
                                <i class="fas ${window.state.isDarkMode ? 'fa-sun text-yellow-500 !text-yellow-500' : 'fa-moon text-blue-600 !text-blue-600'}"></i>
                            </button>
                            <button onclick="window.state.isLoginModalOpen = true; render();" class="bg-primary !text-white w-10 h-10 rounded-xl flex items-center justify-center shadow-lg hover:brightness-110 transition">
                                <i class="fas fa-user-shield"></i>
                            </button>
                        </div>
                    </div>
                </header>`;
        }

        function ProductCard(p) {
            return `
                <div class="bg-white dark:bg-gray-800 rounded-[2.5rem] overflow-hidden card-shadow border dark:border-gray-700 group flex flex-col h-full hover:scale-105 transition-all duration-300">
                    <div class="relative h-48 overflow-hidden cursor-pointer" onclick="navigate('product_detail', '${p.id}')">
                        <img src="${p.image_url}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110" />
                        ${p.is_top_ten ? `<div class="absolute top-4 left-4 bg-primary !text-white text-[10px] font-black px-3 py-1 rounded-lg">#${p.rank || 'TOP'}</div>` : ''}
                        ${window.state.user?.isAdmin ? `
                            <div class="absolute top-4 right-4 flex gap-2">
                                <button onclick="event.stopPropagation(); openAdminModal('product', '${p.id}')" class="bg-blue-600 !text-white w-8 h-8 rounded-lg flex items-center justify-center text-[10px]"><i class="fas fa-edit"></i></button>
                                <button onclick="event.stopPropagation(); handleDelete('products', '${p.id}')" class="bg-red-600 !text-white w-8 h-8 rounded-lg flex items-center justify-center text-[10px]"><i class="fas fa-trash"></i></button>
                            </div>` : ''}
                    </div>
                    <div class="p-6 flex flex-col flex-grow">
                        <h3 class="font-black text-sm uppercase mb-6 line-clamp-1">${p.name}</h3>
                        <div class="mt-auto space-y-3">
                            <div class="flex flex-col space-y-0.5">
                                <span class="text-[8px] font-black uppercase opacity-40">Mercado Livre</span>
                                <span class="text-sm font-black text-primary !text-primary">${formatCurrency(p.price_ml || p.price_low)}</span>
                            </div>
                            <div class="flex flex-col space-y-0.5">
                                <span class="text-[8px] font-black uppercase opacity-40">Amazon</span>
                                <span class="text-sm font-black text-yellow-600 !text-yellow-600">${p.price_amazon ? formatCurrency(p.price_amazon) : '---'}</span>
                            </div>
                            <button onclick="navigate('product_detail', '${p.id}')" class="w-full bg-primary/10 text-primary py-3 rounded-xl text-[10px] font-black uppercase hover:bg-primary hover:!text-white transition !text-primary">Review Completo</button>
                        </div>
                    </div>
                </div>`;
        }

        function NewsCard(n) {
            return `
                <div class="bg-white dark:bg-gray-900 rounded-[2.5rem] overflow-hidden card-shadow cursor-pointer border dark:border-gray-800 hover:border-primary transition group" onclick="navigate('news_detail', '${n.id}')">
                    <div class="relative h-64 overflow-hidden">
                        <img src="${n.image_url}" class="w-full h-full object-cover group-hover:scale-105 transition duration-700" />
                        ${window.state.user?.isAdmin ? `
                            <div class="absolute top-6 right-6 flex gap-2">
                                <button onclick="event.stopPropagation(); openAdminModal('news', '${n.id}')" class="bg-blue-600 !text-white w-10 h-10 rounded-xl flex items-center justify-center"><i class="fas fa-edit"></i></button>
                                <button onclick="event.stopPropagation(); handleDelete('news', '${n.id}')" class="bg-red-600 !text-white w-10 h-10 rounded-xl flex items-center justify-center"><i class="fas fa-trash"></i></button>
                            </div>` : ''}
                    </div>
                    <div class="p-8">
                        <span class="text-[10px] font-black uppercase text-primary mb-4 block !text-primary">${n.category} ‚Ä¢ ${n.date}</span>
                        <h3 class="text-2xl font-black uppercase leading-tight line-clamp-2">${n.title}</h3>
                    </div>
                </div>`;
        }

        function Footer() {
            return `
                <footer class="bg-primary !text-white py-24 mt-24">
                    <div class="max-w-7xl mx-auto px-4 text-center">
                        <div class="flex justify-center items-center space-x-3 mb-8 cursor-pointer" onclick="navigate('home')">
                            <i class="fas fa-bolt text-4xl"></i>
                            <span class="font-black text-4xl uppercase tracking-tighter !text-white">verbenaTec</span>
                        </div>
                        <p class="text-[10px] uppercase font-black tracking-widest opacity-50">Reviews e Not√≠cias de Tecnologia ‚Ä¢ 2024</p>
                    </div>
                </footer>`;
        }

        function Modals() {
            return `
                ${window.state.isLoginModalOpen ? `
                <div class="modal-overlay" onclick="window.state.isLoginModalOpen = false; render();">
                    <div class="bg-white dark:bg-gray-900 w-full max-w-md rounded-[2.5rem] p-10 shadow-2xl animate-fade-in border dark:border-gray-800" onclick="event.stopPropagation()">
                        <h2 class="text-3xl font-black uppercase tracking-tighter mb-10">Admin Login</h2>
                        <form onsubmit="handleAuth(event)" class="space-y-6">
                            <div class="space-y-1">
                                <label class="text-[10px] font-black uppercase opacity-40 ml-2">E-mail</label>
                                <input type="email" name="email" required placeholder="admin@verbenatec.com" />
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-black uppercase opacity-40 ml-2">Senha</label>
                                <input type="password" name="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                            </div>
                            <button type="submit" class="w-full bg-primary !text-white py-5 rounded-2xl font-black uppercase shadow-2xl hover:brightness-110 transition mt-4">Entrar Agora</button>
                        </form>
                    </div>
                </div>` : ''}

                ${window.state.isAdminModalOpen ? `
                <div class="modal-overlay overflow-y-auto" onclick="window.state.isAdminModalOpen = false; render();">
                    <div class="bg-white dark:bg-gray-950 w-full max-w-4xl rounded-[3rem] p-8 md:p-14 my-10 animate-fade-in border dark:border-gray-800" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-10">
                            <h2 class="text-3xl font-black uppercase tracking-tighter">${window.state.editingItem ? 'Editar Registro' : 'Novo Conte√∫do'}</h2>
                            <button onclick="window.state.isAdminModalOpen = false; render();" class="w-12 h-12 rounded-2xl bg-gray-100 dark:bg-gray-800 hover:text-red-500 transition"><i class="fas fa-times text-xl"></i></button>
                        </div>

                        <div class="flex space-x-3 mb-10 p-1.5 bg-gray-100 dark:bg-gray-900 rounded-2xl">
                            <button onclick="window.state.adminTab = 'product'; render();" class="flex-1 py-4 rounded-xl font-black uppercase text-[10px] transition ${window.state.adminTab === 'product' ? 'bg-primary !text-white shadow-xl' : 'opacity-40'}">Produtos</button>
                            <button onclick="window.state.adminTab = 'news'; render();" class="flex-1 py-4 rounded-xl font-black uppercase text-[10px] transition ${window.state.adminTab === 'news' ? 'bg-primary !text-white shadow-xl' : 'opacity-40'}">Not√≠cias</button>
                        </div>

                        ${window.state.adminTab === 'product' ? `
                        <form onsubmit="handleSaveProduct(event)" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="col-span-full form-header"><h3 class="font-black uppercase text-xs opacity-50">Informa√ß√µes T√©cnicas</h3></div>
                            <div class="col-span-full space-y-1"><label class="text-[10px] font-black uppercase opacity-40 ml-2">Modelo</label><input name="name" value="${window.state.editingItem?.name || ''}" required /></div>
                            <div class="space-y-1"><label class="text-[10px] font-black uppercase opacity-40 ml-2">Categoria</label><select name="category">${['celular', 'fones', 'videogames', 'jogos', 'acessorios'].map(c => `<option value="${c}" ${window.state.editingItem?.category === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div>
                            <div class="space-y-1"><label class="text-[10px] font-black uppercase opacity-40 ml-2">URL Imagem</label><input name="image_url" value="${window.state.editingItem?.image_url || ''}" required /></div>
                            
                            <div class="col-span-full form-header mt-4"><h3 class="font-black uppercase text-xs opacity-50">Valores e Links</h3></div>
                            <div class="space-y-1"><label class="text-[10px] font-black uppercase opacity-40 ml-2">Pre√ßo Mercado Livre</label><input name="price_ml_masked" oninput="maskCurrency(this)" value="${formatPriceValue(window.state.editingItem?.price_ml || window.state.editingItem?.price_low)}" required /></div>
                            <div class="space-y-1"><label class="text-[10px] font-black uppercase opacity-40 ml-2">Pre√ßo Amazon</label><input name="price_amazon_masked" oninput="maskCurrency(this)" value="${formatPriceValue(window.state.editingItem?.price_amazon)}" /></div>
                            <div class="space-y-1"><label class="text-[10px] font-black uppercase opacity-40 ml-2">Nota Review (0-10)</label><input type="number" step="0.1" name="quality_score" value="${window.state.editingItem?.quality_score || ''}" required /></div>
                            <div class="space-y-1"><label class="text-[10px] font-black uppercase opacity-40 ml-2">Posi√ß√£o Top 10</label><input type="number" name="rank" value="${window.state.editingItem?.rank || ''}" /></div>
                            <div class="space-y-1"><label class="text-[10px] font-black uppercase opacity-40 ml-2">Link Afiliado ML</label><input name="affiliate_url" value="${window.state.editingItem?.affiliate_url || ''}" required /></div>
                            <div class="space-y-1"><label class="text-[10px] font-black uppercase opacity-40 ml-2">Link Afiliado Amazon</label><input name="amazon_url" value="${window.state.editingItem?.amazon_url || ''}" /></div>

                            <div class="col-span-full space-y-4">
                                <div class="flex justify-between items-center"><label class="text-[10px] font-black uppercase opacity-40 ml-2">Review Completo</label><button type="button" onclick="generateAIReview()" class="text-[10px] font-black text-blue-500 uppercase flex items-center !text-blue-500 no-contrast">${window.state.isGeneratingAI ? '<i class="fas fa-spinner fa-spin mr-2"></i> Criando...' : '<i class="fas fa-robot mr-2"></i> Gerar com Gemini'}</button></div>
                                <textarea name="review" id="review_field" class="h-44 leading-relaxed">${window.state.editingItem?.review || ''}</textarea>
                                <label class="flex items-center space-x-3 p-4 bg-gray-50 dark:bg-gray-900 rounded-2xl cursor-pointer border dark:border-gray-800">
                                    <input type="checkbox" name="is_top_ten" ${window.state.editingItem?.is_top_ten ? 'checked' : ''} class="w-6 h-6 rounded-lg accent-primary" />
                                    <span class="font-black uppercase text-xs">Ativar no Top 10 Oficial</span>
                                </label>
                            </div>
                            <button type="submit" class="col-span-full bg-primary !text-white py-6 rounded-3xl font-black uppercase shadow-2xl hover:brightness-110 transition-all mt-6">Salvar Item</button>
                        </form>` : `
                        <form onsubmit="handleSaveNews(event)" class="space-y-8">
                            <div class="space-y-1"><label class="text-[10px] font-black uppercase opacity-40 ml-2">Manchete</label><input name="title" value="${window.state.editingItem?.title || ''}" required /></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="space-y-1"><label class="text-[10px] font-black uppercase opacity-40 ml-2">Categoria</label><select name="category">${['celular', 'fones', 'videogames', 'jogos', 'acessorios'].map(c => `<option value="${c}" ${window.state.editingItem?.category === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div>
                                <div class="space-y-1"><label class="text-[10px] font-black uppercase opacity-40 ml-2">URL Imagem</label><input name="image_url" value="${window.state.editingItem?.image_url || ''}" required /></div>
                            </div>
                            <div class="space-y-4"><label class="text-[10px] font-black uppercase opacity-40 ml-2">Artigo Completo</label><textarea name="content" class="h-64 leading-relaxed">${window.state.editingItem?.content || ''}</textarea></div>
                            <button type="submit" class="w-full bg-primary !text-white py-6 rounded-3xl font-black uppercase shadow-2xl hover:brightness-110 transition mt-6">Publicar Not√≠cia</button>
                        </form>`}
                    </div>
                </div>` : ''}
            `;
        }

        // --- L√ìGICA E UTILIT√ÅRIOS ---

        window.maskCurrency = (input) => {
            let value = input.value.replace(/\D/g, "");
            value = (value / 100).toFixed(2) + "";
            value = value.replace(".", ",");
            value = value.replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,");
            value = value.replace(/(\d)(\d{3}),/g, "$1.$2,");
            input.value = value !== "NaN" && value !== "0,00" ? "R$ " + value : "";
        };

        const formatPriceValue = (val) => {
            if (!val) return "";
            return "R$ " + Number(val).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        };

        const unmaskPrice = (val) => {
            if (!val || typeof val !== 'string') return 0;
            return parseFloat(val.replace("R$ ", "").replace(/\./g, "").replace(",", ".")) || 0;
        };

        async function fetchData() {
            window.state.loading = true; window.render();
            try {
                const [pRes, nRes] = await Promise.all([
                    supabase.from('products').select('*').order('created_at', { ascending: false }),
                    supabase.from('news').select('*').order('created_at', { ascending: false })
                ]);
                window.state.products = pRes.data || [];
                window.state.news = nRes.data || [];
            } catch (err) { console.error("Database error", err); }
            window.state.loading = false; window.render();
        }

        window.navigate = (view, id = null, category = 'all') => {
            window.state.view = view; window.state.selectedId = id; window.state.activeCategory = category;
            window.scrollTo({ top: 0, behavior: 'smooth' }); window.render();
        };

        window.toggleDarkMode = () => {
            window.state.isDarkMode = !window.state.isDarkMode;
            document.documentElement.classList.toggle('dark', window.state.isDarkMode); window.render();
        };

        window.handleAuth = (event) => {
            event.preventDefault();
            const email = event.target.email.value;
            const pass = event.target.password.value;
            if (email === 'emanuelrothmamn@gmail.com' && pass === 'senhadmin') {
                window.state.user = { email, isAdmin: true, name: 'Admin Verbena' };
                localStorage.setItem('verbenatec_user', JSON.stringify(window.state.user));
                window.state.isLoginModalOpen = false; window.render();
            } else alert("Credenciais Inv√°lidas");
        };

        window.handleDelete = async (table, id) => {
            if (!confirm(`Excluir permanentemente?`)) return;
            const { error } = await supabase.from(table).delete().eq('id', id);
            if (!error) fetchData();
        };

        window.openAdminModal = (tab, id = null) => {
            window.state.adminTab = tab;
            if (id) {
                const list = tab === 'product' ? window.state.products : window.state.news;
                window.state.editingItem = JSON.parse(JSON.stringify(list.find(i => i.id === id)));
            } else window.state.editingItem = null;
            window.state.isAdminModalOpen = true; window.render();
        };

        window.handleSaveProduct = async (event) => {
            event.preventDefault();
            const fd = new FormData(event.target);
            const id = window.state.editingItem?.id || Math.random().toString(36).substr(2, 9);
            const priceMl = unmaskPrice(fd.get('price_ml_masked'));
            const payload = {
                id,
                name: fd.get('name'),
                category: fd.get('category'),
                quality_score: Number(fd.get('quality_score')),
                price_ml: priceMl,
                price_amazon: unmaskPrice(fd.get('price_amazon_masked')),
                price_low: priceMl,
                is_top_ten: fd.get('is_top_ten') === 'on',
                rank: fd.get('rank') ? Number(fd.get('rank')) : null,
                image_url: fd.get('image_url'),
                affiliate_url: fd.get('affiliate_url'),
                amazon_url: fd.get('amazon_url'),
                review: fd.get('review')
            };
            const { error } = await (window.state.editingItem ? supabase.from('products').update(payload).eq('id', id) : supabase.from('products').insert([payload]));
            if (!error) { window.state.isAdminModalOpen = false; fetchData(); } else alert(error.message);
        };

        window.handleSaveNews = async (event) => {
            event.preventDefault();
            const fd = new FormData(event.target);
            const id = window.state.editingItem?.id || Math.random().toString(36).substr(2, 9);
            const payload = {
                id, title: fd.get('title'), content: fd.get('content'), category: fd.get('category'), image_url: fd.get('image_url'),
                date: window.state.editingItem?.date || new Date().toLocaleDateString('pt-BR')
            };
            const { error } = await (window.state.editingItem ? supabase.from('news').update(payload).eq('id', id) : supabase.from('news').insert([payload]));
            if (!error) { window.state.isAdminModalOpen = false; fetchData(); } else alert(error.message);
        };

        window.generateAIReview = async () => {
            const name = document.querySelector('input[name="name"]').value;
            if (!name) return alert("Insira o nome do modelo primeiro.");
            window.state.isGeneratingAI = true; window.render();
            try {
                const response = await ai.models.generateContent({
                    model: 'gemini-3-flash-preview',
                    contents: `Atue como reviewer t√©cnico. Escreva um review curto (max 150 palavras) para o produto: ${name}. Destaque pontos fortes, fracos e veredito final.`
                });
                document.getElementById('review_field').value = response.text;
            } catch (e) { alert("Falha ao gerar com AI."); }
            window.state.isGeneratingAI = false; window.render();
        };

        const formatCurrency = (val) => Number(val).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        fetchData();
    </script>
</body>
</html>