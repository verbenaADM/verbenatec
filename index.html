<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VerbenaTec - Review & Tecnologia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        :root { --primary: #1E40AF; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            transition: background-color 0.3s, color 0.3s; 
            overflow-x: hidden;
            margin: 0;
            min-height: 100vh;
        }

        /* FOR√áANDO CORES DE TEXTO CONFORME SOLICITADO */
        .dark { background-color: #030712; color: #ffffff !important; }
        html:not(.dark) { background-color: #ffffff; color: #000000 !important; }

        /* Garantindo contraste em elementos comuns */
        .dark p, .dark span, .dark h1, .dark h2, .dark h3, .dark h4, .dark div:not(.bg-primary) { color: #ffffff !important; }
        html:not(.dark) p, html:not(.dark) span, html:not(.dark) h1, html:not(.dark) h2, html:not(.dark) h3, html:not(.dark) h4, html:not(.dark) div:not(.bg-primary) { color: #000000 !important; }

        /* Exce√ß√µes para bot√µes e links de destaque */
        .bg-primary *, .btn-primary, .text-white { color: #ffffff !important; }
        .text-primary { color: var(--primary) !important; }
        
        .line-clamp-1 { display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .modal-overlay { 
            background: rgba(0,0,0,0.9); 
            backdrop-filter: blur(8px); 
            position: fixed; 
            inset: 0; 
            z-index: 100; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 1rem; 
        }

        input, select, textarea { 
            width: 100%; 
            padding: 0.85rem; 
            border-radius: 0.75rem; 
            background: #f3f4f6; 
            outline: none; 
            border: 1px solid #d1d5db;
            color: #000000 !important;
        }

        .dark input, .dark select, .dark textarea { 
            background: #1f2937; 
            color: #ffffff !important; 
            border: 1px solid #374151; 
        }

        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { primary: '#1E40AF' } } }
        }
    </script>
</head>
<body class="bg-white dark:bg-gray-950">

    <div id="app"></div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.3';
        import { GoogleGenAI } from 'https://esm.sh/@google/genai@1.34.0';

        // --- DATABASE & AI CONFIG ---
        const supabase = createClient('https://dybizeczoftefwxjptkm.supabase.co', 'sb_publishable_K6eACFcZ35n_bXocHNC-zQ_Tk1vW-9y');
        const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

        // --- GLOBAL STATE ---
        window.state = {
            view: 'home',
            activeCategory: 'all',
            selectedId: null,
            products: [],
            news: [],
            user: JSON.parse(localStorage.getItem('verbenatec_user')) || null,
            isDarkMode: true,
            isMenuOpen: false,
            isAdminModalOpen: false,
            adminTab: 'product',
            isLoginModalOpen: false,
            editingItem: null,
            loading: true,
            selectedNewsProducts: [],
            isGeneratingAI: false
        };

        // --- CORE RENDERER ---
        window.render = function() {
            const container = document.getElementById('app');
            if (window.state.loading) {
                container.innerHTML = `
                    <div class="min-h-screen flex flex-col items-center justify-center bg-gray-950 text-white">
                        <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                        <p class="font-black uppercase tracking-widest text-xs">Carregando VerbenaTec...</p>
                    </div>`;
                return;
            }

            let content = '';
            if (window.state.view === 'home') content = renderHome();
            else if (window.state.view === 'category') content = renderCategory();
            else if (window.state.view === 'product_detail') content = renderProductDetail();
            else if (window.state.view === 'news_detail') content = renderNewsDetail();

            container.innerHTML = `
                ${renderHeader()}
                <main class="min-h-screen">${content}</main>
                ${renderFooter()}
                ${renderModals()}
            `;
        };

        // --- VIEW FUNCTIONS ---
        function renderHome() {
            const topTen = window.state.products.filter(p => p.is_top_ten).sort((a,b) => (a.rank || 99) - (b.rank || 99));
            return `
                <div class="max-w-7xl mx-auto px-4 py-12 space-y-20 animate-fade-in">
                    <section>
                        <h2 class="text-3xl font-black uppercase tracking-tighter border-l-8 border-primary pl-4 mb-10">Verbena News</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            ${window.state.news.slice(0, 4).map(n => NewsCard(n)).join('')}
                        </div>
                    </section>
                    <section class="bg-gray-100 dark:bg-gray-900/40 -mx-4 px-4 py-16 rounded-[3rem]">
                        <h2 class="text-3xl font-black uppercase tracking-widest text-center mb-12">üèÜ Ranking Top 10</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6">
                            ${topTen.slice(0,10).map(p => ProductCard(p)).join('')}
                        </div>
                    </section>
                </div>`;
        }

        function renderCategory() {
            const filtered = window.state.products.filter(p => p.category === window.state.activeCategory || window.state.activeCategory === 'all');
            return `
                <div class="max-w-7xl mx-auto px-4 py-12 animate-fade-in">
                    <h1 class="text-5xl font-black uppercase tracking-tighter text-primary mb-12 text-center">${window.state.activeCategory}</h1>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6">
                        ${filtered.map(p => ProductCard(p)).join('')}
                    </div>
                </div>`;
        }

        function renderProductDetail() {
            const p = window.state.products.find(x => x.id === window.state.selectedId);
            if (!p) return '';
            return `
                <div class="max-w-4xl mx-auto px-4 py-12 animate-fade-in">
                    <button onclick="navigate('home')" class="mb-8 font-black uppercase text-[10px] text-primary flex items-center hover:translate-x-[-4px] transition">
                        <i class="fas fa-arrow-left mr-2"></i> Voltar
                    </button>
                    <div class="bg-white dark:bg-gray-900 rounded-[2.5rem] overflow-hidden shadow-2xl border dark:border-gray-800">
                        <img src="${p.image_url}" class="w-full h-96 object-cover" />
                        <div class="p-8 md:p-16">
                            <h2 class="text-4xl md:text-5xl font-black uppercase tracking-tighter leading-none mb-10">${p.name}</h2>
                            <div class="flex items-center space-x-12 mb-12">
                                <div class="text-center">
                                    <p class="text-[10px] font-black uppercase opacity-50 mb-1">Nota Verbena</p>
                                    <p class="text-5xl font-black text-blue-500">${p.quality_score}</p>
                                </div>
                                <div>
                                    <p class="text-[10px] font-black uppercase opacity-50 mb-1">Pre√ßo Hoje</p>
                                    <p class="text-3xl font-black text-primary">${formatCurrency(p.price_low)}</p>
                                    ${p.price_high > p.price_low ? `<span class="text-sm opacity-50 line-through">${formatCurrency(p.price_high)}</span>` : ''}
                                </div>
                            </div>
                            <div class="text-lg leading-relaxed whitespace-pre-line mb-12">${p.review || p.description}</div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-10 border-t dark:border-gray-800">
                                <a href="${p.affiliate_url}" target="_blank" class="bg-primary text-white text-center py-5 rounded-2xl font-black uppercase shadow-xl hover:scale-[1.02] transition">Comprar no Mercado Livre</a>
                                ${p.amazon_url ? `<a href="${p.amazon_url}" target="_blank" class="bg-yellow-500 text-black text-center py-5 rounded-2xl font-black uppercase shadow-xl hover:scale-[1.02] transition">Comprar na Amazon</a>` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        function renderNewsDetail() {
            const n = window.state.news.find(x => x.id === window.state.selectedId);
            if (!n) return '';
            const related = window.state.products.filter(p => n.related_product_ids?.includes(p.id));
            return `
                <div class="max-w-4xl mx-auto px-4 py-12 animate-fade-in">
                    <button onclick="navigate('home')" class="mb-8 font-black uppercase text-[10px] text-primary flex items-center hover:translate-x-[-4px] transition">
                        <i class="fas fa-arrow-left mr-2"></i> Voltar
                    </button>
                    <article class="bg-white dark:bg-gray-900 rounded-[2.5rem] overflow-hidden shadow-2xl border dark:border-gray-800">
                        <img src="${n.image_url}" class="w-full h-96 object-cover" />
                        <div class="p-8 md:p-20">
                            <h1 class="text-4xl md:text-6xl font-black uppercase tracking-tighter leading-none mb-10">${n.title}</h1>
                            <div class="text-xl leading-relaxed whitespace-pre-line mb-12">${n.content}</div>
                            ${related.length > 0 ? `
                                <div class="mt-20 pt-10 border-t dark:border-gray-800">
                                    <h3 class="text-xl font-black uppercase mb-10">Itens Citados</h3>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">${related.map(p => ProductCard(p)).join('')}</div>
                                </div>
                            ` : ''}
                        </div>
                    </article>
                </div>`;
        }

        // --- COMPONENTS ---
        function renderHeader() {
            const cats = ['all', 'celular', 'fones', 'videogames', 'jogos', 'acessorios'];
            return `
                <header class="sticky top-0 z-50 bg-white/95 dark:bg-gray-950/95 backdrop-blur border-b dark:border-gray-800 shadow-sm">
                    <div class="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between">
                        <div onclick="navigate('home')" class="flex items-center space-x-2 cursor-pointer group">
                            <div class="bg-primary p-2 rounded-lg text-white shadow-lg group-hover:rotate-6 transition-transform">
                                <i class="fas fa-microchip text-xl"></i>
                            </div>
                            <h1 class="text-2xl font-black uppercase tracking-tighter">Verbena<span class="text-blue-600">Tec</span></h1>
                        </div>
                        <nav class="hidden lg:flex space-x-8">
                            ${cats.map(c => `
                                <button onclick="navigate('category', null, '${c}')" class="text-[10px] font-black uppercase tracking-widest transition ${window.state.activeCategory === c ? 'text-primary' : 'opacity-60 hover:opacity-100'}">
                                    ${c === 'all' ? 'In√≠cio' : c}
                                </button>
                            `).join('')}
                        </nav>
                        <div class="flex items-center space-x-4">
                            <button onclick="toggleDarkMode()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                                <i class="fas ${window.state.isDarkMode ? 'fa-sun text-yellow-500' : 'fa-moon text-blue-600'}"></i>
                            </button>
                            <button onclick="window.state.isLoginModalOpen = true; render();" class="bg-primary text-white p-2 rounded-lg hover:bg-blue-700 transition">
                                <i class="fas fa-user-shield"></i>
                            </button>
                        </div>
                    </div>
                </header>`;
        }

        function ProductCard(p) {
            return `
                <div class="bg-white dark:bg-gray-800 rounded-3xl overflow-hidden shadow-lg border dark:border-gray-700 flex flex-col h-full group relative transition-all duration-300 hover:shadow-2xl hover:-translate-y-1 animate-fade-in">
                    ${window.state.user?.isAdmin ? `
                        <div class="absolute top-2 right-2 z-20 flex gap-2">
                            <button onclick="openAdminModal('product', '${p.id}')" class="bg-blue-600 text-white p-2 rounded-xl text-[10px] shadow-lg"><i class="fas fa-edit"></i></button>
                            <button onclick="handleDelete('products', '${p.id}')" class="bg-red-600 text-white p-2 rounded-xl text-[10px] shadow-lg"><i class="fas fa-trash"></i></button>
                        </div>` : ''}
                    <div class="h-44 overflow-hidden cursor-pointer" onclick="navigate('product_detail', '${p.id}')">
                        <img src="${p.image_url}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" />
                        ${p.is_top_ten ? `<div class="absolute top-3 left-3 bg-primary text-white text-[10px] font-black px-2 py-1 rounded shadow-lg">#${p.rank || 'TOP'}</div>` : ''}
                    </div>
                    <div class="p-5 flex flex-col flex-grow">
                        <h3 class="font-black text-sm uppercase mb-3 line-clamp-1">${p.name}</h3>
                        <div class="mt-auto">
                            <div class="mb-4">
                                <p class="text-lg font-black text-primary leading-none">${formatCurrency(p.price_low)}</p>
                                ${p.price_high > p.price_low ? `<p class="text-[10px] opacity-40 line-through">${formatCurrency(p.price_high)}</p>` : ''}
                            </div>
                            <button onclick="navigate('product_detail', '${p.id}')" class="w-full bg-primary/10 text-primary py-2.5 rounded-xl text-[10px] font-black uppercase mb-2 hover:bg-primary hover:text-white transition">Review</button>
                            <a href="${p.affiliate_url}" target="_blank" class="block w-full bg-primary text-white text-center py-2.5 rounded-xl text-[10px] font-black uppercase shadow-md">Mercado Livre</a>
                        </div>
                    </div>
                </div>`;
        }

        function NewsCard(n) {
            return `
                <div class="bg-white dark:bg-gray-900 rounded-[2rem] overflow-hidden shadow-lg border dark:border-gray-800 cursor-pointer group animate-fade-in" onclick="navigate('news_detail', '${n.id}')">
                    <div class="h-64 overflow-hidden">
                        <img src="${n.image_url}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700" />
                    </div>
                    <div class="p-8">
                        <span class="text-[10px] font-black uppercase text-primary tracking-widest mb-4 block">${n.category} ‚Ä¢ ${n.date}</span>
                        <h3 class="text-2xl font-black uppercase group-hover:text-primary transition line-clamp-2 leading-tight">${n.title}</h3>
                        <p class="opacity-60 text-sm mt-4 line-clamp-2">${n.content}</p>
                    </div>
                </div>`;
        }

        function renderFooter() {
            return `
                <footer class="bg-primary text-white py-20 mt-24">
                    <div class="max-w-7xl mx-auto px-4 text-center">
                        <div class="flex justify-center items-center space-x-2 mb-6">
                            <i class="fas fa-microchip text-3xl"></i>
                            <span class="font-black text-3xl uppercase tracking-tighter">VerbenaTec</span>
                        </div>
                        <p class="text-[10px] opacity-60 uppercase font-black tracking-widest">¬© 2024 ‚Ä¢ Tecnologia de Alto N√≠vel</p>
                    </div>
                </footer>`;
        }

        function renderModals() {
            let modals = '';
            if (window.state.isLoginModalOpen) {
                modals += `
                <div class="modal-overlay" onclick="window.state.isLoginModalOpen = false; render();">
                    <div class="bg-white dark:bg-gray-900 w-full max-w-md rounded-[2rem] p-10 shadow-2xl animate-fade-in" onclick="event.stopPropagation()">
                        <h2 class="text-3xl font-black uppercase tracking-tighter mb-10 text-center">Acesso Admin</h2>
                        <form onsubmit="handleAuth(event)" class="space-y-4">
                            <input type="email" name="email" placeholder="E-mail Admin" required />
                            <input type="password" name="password" placeholder="Senha" required />
                            <button type="submit" class="w-full bg-primary text-white py-5 rounded-2xl font-black uppercase shadow-2xl hover:brightness-110 transition mt-6">Acessar Painel</button>
                        </form>
                    </div>
                </div>`;
            }
            if (window.state.isAdminModalOpen) {
                modals += `
                <div class="modal-overlay overflow-y-auto" onclick="window.state.isAdminModalOpen = false; render();">
                    <div class="bg-white dark:bg-gray-900 w-full max-w-3xl rounded-[2.5rem] p-10 my-10 shadow-2xl animate-fade-in" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-10">
                            <h2 class="text-2xl font-black uppercase">${window.state.editingItem ? 'Editar' : 'Novo'} Registro</h2>
                            <button onclick="window.state.isAdminModalOpen = false; render();"><i class="fas fa-times text-2xl"></i></button>
                        </div>
                        <div class="flex space-x-4 mb-8">
                            <button onclick="window.state.adminTab = 'product'; render();" class="flex-1 py-3 rounded-xl font-black uppercase text-[10px] ${window.state.adminTab === 'product' ? 'bg-primary text-white shadow-xl' : 'opacity-40'}">Produtos</button>
                            <button onclick="window.state.adminTab = 'news'; render();" class="flex-1 py-3 rounded-xl font-black uppercase text-[10px] ${window.state.adminTab === 'news' ? 'bg-primary text-white shadow-xl' : 'opacity-40'}">Not√≠cias</button>
                        </div>
                        ${window.state.adminTab === 'product' ? renderProductForm() : renderNewsForm()}
                    </div>
                </div>`;
            }
            return modals;
        }

        function renderProductForm() {
            const item = window.state.editingItem || {};
            return `
            <form onsubmit="handleSaveProduct(event)" class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <input name="name" value="${item.name || ''}" placeholder="Nome do Aparelho" class="col-span-full" required />
                <select name="category" required>
                    ${['celular', 'fones', 'videogames', 'jogos', 'acessorios'].map(c => `<option value="${c}" ${item.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                </select>
                <input name="image_url" value="${item.image_url || ''}" placeholder="URL da Imagem" required />
                <input name="price_low" type="number" step="0.01" value="${item.price_low || ''}" placeholder="Pre√ßo Oferta" required />
                <input name="price_high" type="number" step="0.01" value="${item.price_high || ''}" placeholder="Pre√ßo Antigo" />
                <input name="quality_score" type="number" step="0.1" value="${item.quality_score || ''}" placeholder="Nota (0-10)" required />
                <input name="rank" type="number" value="${item.rank || ''}" placeholder="Posi√ß√£o Top 10" />
                <input name="affiliate_url" value="${item.affiliate_url || ''}" placeholder="Link Mercado Livre" class="col-span-full" required />
                <input name="amazon_url" value="${item.amazon_url || ''}" placeholder="Link Amazon" class="col-span-full" />
                <div class="col-span-full">
                    <div class="flex justify-between items-center mb-2">
                        <label class="font-black uppercase text-[10px] opacity-60">Review T√©cnico</label>
                        <button type="button" onclick="generateAIReview()" class="text-blue-600 font-black text-[10px] uppercase hover:underline">
                            ${window.state.isGeneratingAI ? '<i class="fas fa-spinner fa-spin"></i> Gerando...' : '<i class="fas fa-robot"></i> Gerar com IA'}
                        </button>
                    </div>
                    <textarea name="review" id="review_field" class="h-44" required>${item.review || ''}</textarea>
                </div>
                <label class="col-span-full flex items-center space-x-3 p-4 bg-gray-50 dark:bg-gray-800 rounded-2xl cursor-pointer">
                    <input name="is_top_ten" type="checkbox" ${item.is_top_ten ? 'checked' : ''} class="w-6 h-6 rounded accent-primary" />
                    <span class="font-black uppercase text-xs">Ativar no Top 10</span>
                </label>
                <button type="submit" class="col-span-full bg-primary text-white py-6 rounded-2xl font-black uppercase shadow-2xl">Salvar Produto</button>
            </form>`;
        }

        function renderNewsForm() {
            const item = window.state.editingItem || {};
            return `
            <form onsubmit="handleSaveNews(event)" class="space-y-5">
                <input name="title" value="${item.title || ''}" placeholder="T√≠tulo da Not√≠cia" required />
                <div class="grid grid-cols-2 gap-4">
                    <select name="category" required>
                        ${['celular', 'fones', 'videogames', 'jogos', 'acessorios'].map(c => `<option value="${c}" ${item.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                    </select>
                    <input name="image_url" value="${item.image_url || ''}" placeholder="Capa URL" required />
                </div>
                <div class="p-6 bg-gray-50 dark:bg-gray-800 rounded-2xl border dark:border-gray-700">
                    <p class="font-black uppercase text-[10px] opacity-40 mb-4">Vincular Produtos</p>
                    <div class="grid grid-cols-2 gap-3 max-h-40 overflow-y-auto pr-2">
                        ${window.state.products.map(p => `
                            <label class="flex items-center space-x-2 text-[10px] font-bold">
                                <input type="checkbox" onchange="toggleRelated('${p.id}')" ${window.state.selectedNewsProducts.includes(p.id) ? 'checked' : ''} />
                                <span class="truncate">${p.name}</span>
                            </label>`).join('')}
                    </div>
                </div>
                <textarea name="content" class="h-60" placeholder="Conte√∫do da mat√©ria..." required>${item.content || ''}</textarea>
                <button type="submit" class="w-full bg-primary text-white py-6 rounded-2xl font-black uppercase shadow-2xl">Publicar Not√≠cia</button>
            </form>`;
        }

        // --- HANDLERS ---
        window.navigate = (view, id = null, cat = 'all') => {
            window.state.view = view;
            window.state.selectedId = id;
            window.state.activeCategory = cat;
            window.state.isMenuOpen = false;
            window.scrollTo(0, 0);
            window.render();
        };

        window.toggleDarkMode = () => {
            window.state.isDarkMode = !window.state.isDarkMode;
            document.documentElement.classList.toggle('dark', window.state.isDarkMode);
            window.render();
        };

        window.handleAuth = (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            if (fd.get('email') === 'emanuelrothmamn@gmail.com' && fd.get('password') === 'senhadmin') {
                window.state.user = { isAdmin: true };
                localStorage.setItem('verbenatec_user', JSON.stringify(window.state.user));
                window.state.isLoginModalOpen = false;
                window.render();
            } else alert('Acesso negado');
        };

        window.handleDelete = async (table, id) => {
            if (!confirm('Deseja excluir?')) return;
            await supabase.from(table).delete().eq('id', id);
            fetchData();
        };

        window.openAdminModal = (tab, id = null) => {
            window.state.adminTab = tab;
            if (id) {
                const list = tab === 'product' ? window.state.products : window.state.news;
                window.state.editingItem = list.find(x => x.id === id);
                window.state.selectedNewsProducts = window.state.editingItem.related_product_ids || [];
            } else {
                window.state.editingItem = null;
                window.state.selectedNewsProducts = [];
            }
            window.state.isAdminModalOpen = true;
            window.render();
        };

        window.handleSaveProduct = async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const id = window.state.editingItem?.id || Math.random().toString(36).substr(2, 9);
            const data = {
                id,
                name: fd.get('name'),
                category: fd.get('category'),
                price_low: Number(fd.get('price_low')),
                price_high: Number(fd.get('price_high')),
                quality_score: Number(fd.get('quality_score')),
                rank: fd.get('rank') ? Number(fd.get('rank')) : null,
                is_top_ten: fd.get('is_top_ten') === 'on',
                image_url: fd.get('image_url'),
                affiliate_url: fd.get('affiliate_url'),
                amazon_url: fd.get('amazon_url'),
                review: fd.get('review'),
                description: fd.get('review').substring(0, 100)
            };
            await (window.state.editingItem ? supabase.from('products').update(data).eq('id', id) : supabase.from('products').insert([data]));
            window.state.isAdminModalOpen = false;
            fetchData();
        };

        window.handleSaveNews = async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const id = window.state.editingItem?.id || Math.random().toString(36).substr(2, 9);
            const data = {
                id,
                title: fd.get('title'),
                content: fd.get('content'),
                category: fd.get('category'),
                image_url: fd.get('image_url'),
                date: new Date().toLocaleDateString('pt-BR'),
                related_product_ids: window.state.selectedNewsProducts
            };
            await (window.state.editingItem ? supabase.from('news').update(data).eq('id', id) : supabase.from('news').insert([data]));
            window.state.isAdminModalOpen = false;
            fetchData();
        };

        window.toggleRelated = (id) => {
            const index = window.state.selectedNewsProducts.indexOf(id);
            if (index === -1) window.state.selectedNewsProducts.push(id);
            else window.state.selectedNewsProducts.splice(index, 1);
        };

        window.generateAIReview = async () => {
            const name = document.querySelector('input[name="name"]').value;
            if (!name) return alert('D√™ um nome ao produto primeiro');
            window.state.isGeneratingAI = true;
            window.render();
            try {
                const response = await ai.models.generateContent({
                    model: 'gemini-3-flash-preview',
                    contents: `Escreva um review t√©cnico de 150 palavras para o produto ${name}. Seja objetivo, mencione pr√≥s e contras.`
                });
                document.getElementById('review_field').value = response.text;
            } catch (e) { alert('Erro na IA'); }
            window.state.isGeneratingAI = false;
            window.render();
        };

        const formatCurrency = (v) => Number(v).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        async function fetchData() {
            window.state.loading = true;
            window.render();
            const [p, n] = await Promise.all([
                supabase.from('products').select('*').order('created_at', { ascending: false }),
                supabase.from('news').select('*').order('created_at', { ascending: false })
            ]);
            window.state.products = p.data || [];
            window.state.news = n.data || [];
            window.state.loading = false;
            window.render();
        }

        fetchData();
    </script>
</body>
</html>